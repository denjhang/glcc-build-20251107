#VCPUv4

# ======== ('DATA', 'console_info', code0, 20, 2)
def code0():
	align(2);
	label('console_info');
	words(15); # 15
	words(26); # 26
	bytes(0,16);
	bytes(32,48);
	bytes(64,80);
	bytes(96,112);
	bytes(128,144);
	bytes(160,176);
	bytes(192,208);
	bytes(224);
	space(1);
# ======== ('CODE', '_console_reset', code1)
def code1():
	label('_console_reset');
	_PROLOGUE(12,6,0x80); # save=R7
	LDW(R8);STW(R7);
	LDWI('_con128ksetup');CALL(vAC);
	_SP(-2+12);STW(R23);
	LDWI('videoTable');PEEK();ST(vACH);ORI(255);XORI(255);DOKE(R23);
	LDW(R7);_BLT('.16');
	_SP(-2+12);DEEK();STW(R8);
	LDW(R7);STW(R9);
	LDI(120);STW(R10);
	LDWI('_console_clear');CALL(vAC);
	label('.16');
	label('.15');
	_EPILOGUE(12,6,0x80);
# ======== (epilog)
code=[
	('EXPORT', 'console_info'),
	('DATA', 'console_info', code0, 20, 2),
	('EXPORT', '_console_reset'),
	('CODE', '_console_reset', code1),
	('IMPORT', '_con128ksetup'),
	('IMPORT', 'videoTable'),
	('IMPORT', '_console_clear') ]
module(code=code, name='../gigatron/map128k/libcon1/cons_geom.c', cpu=4);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv5

# ======== ('DATA', 'console_info', code0, 20, 2)
def code0():
	align(2);
	label('console_info');
	words(15); # 15
	words(26); # 26
	bytes(0,16);
	bytes(32,48);
	bytes(64,80);
	bytes(96,112);
	bytes(128,144);
	bytes(160,176);
	bytes(192,208);
	bytes(224);
	space(1);
# ======== ('CODE', '_console_reset', code1)
def code1():
	label('_console_reset');
	_PROLOGUE(12,6,0x80); # save=R7
	LDW(R8);STW(R7);
	CALLI('_con128ksetup');
	_SP(-2+12);STW(R23);
	LDWI('videoTable');PEEK();ST(vACH);ORI(255);XORI(255);DOKE(R23);
	LDW(R7);_BLT('.16');
	_SP(-2+12);DEEK();STW(R8);
	LDW(R7);STW(R9);
	LDI(120);STW(R10);
	CALLI('_console_clear');
	label('.16');
	label('.15');
	_EPILOGUE(12,6,0x80);
# ======== (epilog)
code=[
	('EXPORT', 'console_info'),
	('DATA', 'console_info', code0, 20, 2),
	('EXPORT', '_console_reset'),
	('CODE', '_console_reset', code1),
	('IMPORT', '_con128ksetup'),
	('IMPORT', 'videoTable'),
	('IMPORT', '_console_clear') ]
module(code=code, name='../gigatron/map128k/libcon1/cons_geom.c', cpu=5);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv6

# ======== ('DATA', 'console_info', code0, 20, 2)
def code0():
	align(2);
	label('console_info');
	words(15); # 15
	words(26); # 26
	bytes(0,16);
	bytes(32,48);
	bytes(64,80);
	bytes(96,112);
	bytes(128,144);
	bytes(160,176);
	bytes(192,208);
	bytes(224);
	space(1);
# ======== ('CODE', '_console_reset', code1)
def code1():
	label('_console_reset');
	_PROLOGUE(12,6,0x80); # save=R7
	LDW(R8);STW(R7);
	CALLI('_con128ksetup');
	LDWI('videoTable');PEEK();ST(v(R23)+1);MOVQB(0,R23);
	_SP(-2+12);DOKEA(R23);
	LDW(R7);_BLT('.16');
	_SP(-2+12);DEEKA(R8);
	LDW(R7);STW(R9);
	MOVQW(120,R10);
	CALLI('_console_clear');
	label('.16');
	label('.15');
	_EPILOGUE(12,6,0x80);
# ======== (epilog)
code=[
	('EXPORT', 'console_info'),
	('DATA', 'console_info', code0, 20, 2),
	('EXPORT', '_console_reset'),
	('CODE', '_console_reset', code1),
	('IMPORT', '_con128ksetup'),
	('IMPORT', 'videoTable'),
	('IMPORT', '_console_clear') ]
module(code=code, name='../gigatron/map128k/libcon1/cons_geom.c', cpu=6);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv7

# ======== ('DATA', 'console_info', code0, 20, 2)
def code0():
	align(2);
	label('console_info');
	words(15); # 15
	words(26); # 26
	bytes(0,16);
	bytes(32,48);
	bytes(64,80);
	bytes(96,112);
	bytes(128,144);
	bytes(160,176);
	bytes(192,208);
	bytes(224);
	space(1);
# ======== ('CODE', '_console_reset', code1)
def code1():
	label('_console_reset');
	_PROLOGUE(12,6,0x80); # save=R7
	MOVW(R8,R7);
	CALLI('_con128ksetup');
	LDWI('videoTable');PEEK();ST(vACH);MOVQB(0,vAC);_STLW(-2+12);
	LDW(R7);_BLT('.16');
	_LDLW(-2+12);STW(R8);
	MOVW(R7,R9);
	MOVQW(120,R10);
	CALLI('_console_clear');
	label('.16');
	label('.15');
	_EPILOGUE(12,6,0x80);
# ======== (epilog)
code=[
	('EXPORT', 'console_info'),
	('DATA', 'console_info', code0, 20, 2),
	('EXPORT', '_console_reset'),
	('CODE', '_console_reset', code1),
	('IMPORT', '_con128ksetup'),
	('IMPORT', 'videoTable'),
	('IMPORT', '_console_clear') ]
module(code=code, name='../gigatron/map128k/libcon1/cons_geom.c', cpu=7);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv4

# ======== ('CODE', 'console_exitm_msgfunc', code0)
def code0():
	label('console_exitm_msgfunc');
	_PROLOGUE(16,6,0xf0); # save=R4-7
	LDW(R8);STW(R7);
	LDW(R9);STW(R6);
	_BEQ('.16');
	LDI(3);STW('console_state');
	label('.18');
	LDWI('console_info');DEEK();STW(v('console_state')+2);
	label('.19');
	label('.22');
	LDWI(257);STW(v('console_state')+4);
	label('.23');
	LDW(R6);STW(R8);
	LDWI(v('console_info')+2);DEEK();STW(R9);
	LDWI('console_print');CALL(vAC);
	label('.16');
	LDI(0);STW(R5);
	LDWI(0x100);PEEK();ORI(128);ST(v(R4)+1);LDI(0);ST(R4);
	LDWI('ctrlBits_v5');PEEK();ANDI(63);ORI(64);STW(R8);
	LDWI('SYS_ExpanderControl');CALL(vAC);
	_BRA('.28');
	label('.27');
	INC(R5);
	LDW(R5);ST(R23);
	LD(R7);ADDW(R4);STW(R22);
	LDW(R23);POKE(R22);
	label('.28');
	_BRA('.27');
	label('.15');
	_EPILOGUE(16,6,0xf0);
# ======== ('CODE', '_console_setup', code1)
def code1():
	label('_console_setup');
	_PROLOGUE(4,0,0x0); # save=None
	LDWI('_exitm_msgfunc');STW(R23);
	LDWI('console_exitm_msgfunc');DOKE(R23);
	LDWI('console_clear_screen');CALL(vAC);
	label('.30');
	_EPILOGUE(4,0,0x0);
# ======== (epilog)
code=[
	('CODE', 'console_exitm_msgfunc', code0),
	('EXPORT', '_console_setup'),
	('CODE', '_console_setup', code1),
	('IMPORT', 'SYS_ExpanderControl'),
	('IMPORT', 'ctrlBits_v5', 'AT', 0x1f8),
	('IMPORT', '_exitm_msgfunc'),
	('IMPORT', 'console_clear_screen'),
	('IMPORT', 'console_print'),
	('IMPORT', 'console_state'),
	('IMPORT', 'console_info') ]
module(code=code, name='../gigatron/map128k/libcon1/cons_setup.c', cpu=4);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv5

# ======== ('CODE', 'console_exitm_msgfunc', code0)
def code0():
	label('console_exitm_msgfunc');
	_PROLOGUE(16,6,0xf0); # save=R4-7
	LDW(R8);STW(R7);
	LDW(R9);STW(R6);
	_BEQ('.16');
	LDI(3);STW('console_state');
	label('.18');
	LDWI('console_info');DEEK();STW(v('console_state')+2);
	label('.19');
	label('.22');
	LDWI(257);STW(v('console_state')+4);
	label('.23');
	LDW(R6);STW(R8);
	LDWI(v('console_info')+2);DEEK();STW(R9);
	CALLI('console_print');
	label('.16');
	LDI(0);STW(R5);
	LDWI(0x100);PEEK();ORI(128);ST(v(R4)+1);LDI(0);ST(R4);
	LDWI('ctrlBits_v5');PEEK();ANDI(63);ORI(64);STW(R8);
	CALLI('SYS_ExpanderControl');
	_BRA('.28');
	label('.27');
	INC(R5);
	LDW(R5);ST(R23);
	LD(R7);ADDW(R4);STW(R22);
	LDW(R23);POKE(R22);
	label('.28');
	_BRA('.27');
	label('.15');
	_EPILOGUE(16,6,0xf0);
# ======== ('CODE', '_console_setup', code1)
def code1():
	label('_console_setup');
	_PROLOGUE(4,0,0x0); # save=None
	LDWI('_exitm_msgfunc');STW(R23);
	LDWI('console_exitm_msgfunc');DOKE(R23);
	CALLI('console_clear_screen');
	label('.30');
	_EPILOGUE(4,0,0x0);
# ======== (epilog)
code=[
	('CODE', 'console_exitm_msgfunc', code0),
	('EXPORT', '_console_setup'),
	('CODE', '_console_setup', code1),
	('IMPORT', 'SYS_ExpanderControl'),
	('IMPORT', 'ctrlBits_v5', 'AT', 0x1f8),
	('IMPORT', '_exitm_msgfunc'),
	('IMPORT', 'console_clear_screen'),
	('IMPORT', 'console_print'),
	('IMPORT', 'console_state'),
	('IMPORT', 'console_info') ]
module(code=code, name='../gigatron/map128k/libcon1/cons_setup.c', cpu=5);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv6

# ======== ('CODE', 'console_exitm_msgfunc', code0)
def code0():
	label('console_exitm_msgfunc');
	_PROLOGUE(16,6,0xf0); # save=R4-7
	LDW(R8);STW(R7);
	LDW(R9);STW(R6);
	_BEQ('.16');
	MOVQW(3,'console_state');
	label('.18');
	LDWI('console_info');DEEK();STW(v('console_state')+2);
	label('.19');
	label('.22');
	LDWI(257);STW(v('console_state')+4);
	label('.23');
	LDW(R6);STW(R8);
	LDWI(v('console_info')+2);DEEKA(R9);
	CALLI('console_print');
	label('.16');
	MOVQB(0,R5);
	LDWI(0x100);PEEK();ORI(128);ST(v(R4)+1);MOVQB(0,R4);
	LDWI('ctrlBits_v5');PEEK();ANDI(63);ORI(64);STW(R8);
	CALLI('SYS_ExpanderControl');
	_BRA('.28');
	label('.27');
	INC(R5);
	LDW(R5);ST(R23);
	LD(R7);ADDW(R4);POKEA(R23);
	label('.28');
	_BRA('.27');
	label('.15');
	_EPILOGUE(16,6,0xf0);
# ======== ('CODE', '_console_setup', code1)
def code1():
	label('_console_setup');
	_PROLOGUE(4,0,0x0); # save=None
	LDWI('_exitm_msgfunc');DOKEI('console_exitm_msgfunc');
	CALLI('console_clear_screen');
	label('.30');
	_EPILOGUE(4,0,0x0);
# ======== (epilog)
code=[
	('CODE', 'console_exitm_msgfunc', code0),
	('EXPORT', '_console_setup'),
	('CODE', '_console_setup', code1),
	('IMPORT', 'SYS_ExpanderControl'),
	('IMPORT', 'ctrlBits_v5', 'AT', 0x1f8),
	('IMPORT', '_exitm_msgfunc'),
	('IMPORT', 'console_clear_screen'),
	('IMPORT', 'console_print'),
	('IMPORT', 'console_state'),
	('IMPORT', 'console_info') ]
module(code=code, name='../gigatron/map128k/libcon1/cons_setup.c', cpu=6);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv7

# ======== ('CODE', 'console_exitm_msgfunc', code0)
def code0():
	label('console_exitm_msgfunc');
	_PROLOGUE(16,6,0xf0); # save=R4-7
	MOVW(R8,R7);
	LDW(R9);STW(R6);
	_BEQ('.16');
	MOVQW(3,'console_state');
	label('.18');
	LDWI('console_info');DEEK();STW(v('console_state')+2);
	label('.19');
	label('.22');
	MOVIW(257,v('console_state')+4);
	label('.23');
	MOVW(R6,R8);
	LDWI(v('console_info')+2);DEEKA(R9);
	CALLI('console_print');
	label('.16');
	MOVQB(0,R5);
	LDWI(0x100);PEEK();ORI(128);ST(v(R4)+1);MOVQB(0,R4);
	LDWI('ctrlBits_v5');PEEK();ANDI(63);ORI(64);STW(R8);
	CALLI('SYS_ExpanderControl');
	_BRA('.28');
	label('.27');
	INC(R5);
	LDW(R5);ST(R23);
	LD(R7);ADDW(R4);POKEA(R23);
	label('.28');
	_BRA('.27');
	label('.15');
	_EPILOGUE(16,6,0xf0);
# ======== ('CODE', '_console_setup', code1)
def code1():
	label('_console_setup');
	_PROLOGUE(4,0,0x0); # save=None
	LDWI('_exitm_msgfunc');DOKEI('console_exitm_msgfunc');
	CALLI('console_clear_screen');
	label('.30');
	_EPILOGUE(4,0,0x0);
# ======== (epilog)
code=[
	('CODE', 'console_exitm_msgfunc', code0),
	('EXPORT', '_console_setup'),
	('CODE', '_console_setup', code1),
	('IMPORT', 'SYS_ExpanderControl'),
	('IMPORT', 'ctrlBits_v5', 'AT', 0x1f8),
	('IMPORT', '_exitm_msgfunc'),
	('IMPORT', 'console_clear_screen'),
	('IMPORT', 'console_print'),
	('IMPORT', 'console_state'),
	('IMPORT', 'console_info') ]
module(code=code, name='../gigatron/map128k/libcon1/cons_setup.c', cpu=7);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv4

# ======== ('CODE', 'main', code0)
def code0():
	label('main');
	_PROLOGUE(12,8,0x0); # save=None
	_SP(-1+12);STW(R23);
	LDWI('ctrlBits_v5');PEEK();POKE(R23);
	LDI(124);STW(R8);
	LDWI('SYS_ExpanderControl');CALL(vAC);
	LDWI(0x8200);STW(R8);
	LDI(3);STW(R9);
	LDI(160);STW(R10);
	LDWI('memset');CALL(vAC);
	_SP(-1+12);PEEK();STW(R8);
	LDWI('SYS_ExpanderControl');CALL(vAC);
	LDWI('.16');STW(R8);
	LDWI('cprintf');CALL(vAC);
	LDI(0);
	label('.15');
	_EPILOGUE(12,8,0x0,saveAC=True);
# ======== ('DATA', '.16', code1, 0, 1)
def code1():
	label('.16');
	bytes(10,10,72,101,108,108,111,32);
	bytes(87,111,114,108,100,10,10,0);
# ======== (epilog)
code=[
	('EXPORT', 'main'),
	('CODE', 'main', code0),
	('IMPORT', 'SYS_ExpanderControl'),
	('IMPORT', 'ctrlBits_v5', 'AT', 0x1f8),
	('IMPORT', 'cprintf'),
	('IMPORT', 'memset'),
	('DATA', '.16', code1, 0, 1) ]
module(code=code, name='../gigatron/map128k/libcon1/test.c', cpu=4);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv5

# ======== ('CODE', 'main', code0)
def code0():
	label('main');
	_PROLOGUE(12,8,0x0); # save=None
	_SP(-1+12);STW(R23);
	LDWI('ctrlBits_v5');PEEK();POKE(R23);
	LDI(124);STW(R8);
	CALLI('SYS_ExpanderControl');
	LDWI(0x8200);STW(R8);
	LDI(3);STW(R9);
	LDI(160);STW(R10);
	CALLI('memset');
	_SP(-1+12);PEEK();STW(R8);
	CALLI('SYS_ExpanderControl');
	LDWI('.16');STW(R8);
	CALLI('cprintf');
	LDI(0);
	label('.15');
	_EPILOGUE(12,8,0x0,saveAC=True);
# ======== ('DATA', '.16', code1, 0, 1)
def code1():
	label('.16');
	bytes(10,10,72,101,108,108,111,32);
	bytes(87,111,114,108,100,10,10,0);
# ======== (epilog)
code=[
	('EXPORT', 'main'),
	('CODE', 'main', code0),
	('IMPORT', 'SYS_ExpanderControl'),
	('IMPORT', 'ctrlBits_v5', 'AT', 0x1f8),
	('IMPORT', 'cprintf'),
	('IMPORT', 'memset'),
	('DATA', '.16', code1, 0, 1) ]
module(code=code, name='../gigatron/map128k/libcon1/test.c', cpu=5);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv6

# ======== ('CODE', 'main', code0)
def code0():
	label('main');
	_PROLOGUE(12,8,0x0); # save=None
	LDWI('ctrlBits_v5');PEEKA(R23);
	_SP(-1+12);POKEA(R23);
	MOVQW(124,R8);
	CALLI('SYS_ExpanderControl');
	LDWI(0x8200);STW(R8);
	MOVQW(3,R9);
	MOVQW(160,R10);
	CALLI('memset');
	_SP(-1+12);PEEK();STW(R8);
	CALLI('SYS_ExpanderControl');
	LDWI('.16');STW(R8);
	CALLI('cprintf');
	LDI(0);
	label('.15');
	_EPILOGUE(12,8,0x0,saveAC=True);
# ======== ('DATA', '.16', code1, 0, 1)
def code1():
	label('.16');
	bytes(10,10,72,101,108,108,111,32);
	bytes(87,111,114,108,100,10,10,0);
# ======== (epilog)
code=[
	('EXPORT', 'main'),
	('CODE', 'main', code0),
	('IMPORT', 'SYS_ExpanderControl'),
	('IMPORT', 'ctrlBits_v5', 'AT', 0x1f8),
	('IMPORT', 'cprintf'),
	('IMPORT', 'memset'),
	('DATA', '.16', code1, 0, 1) ]
module(code=code, name='../gigatron/map128k/libcon1/test.c', cpu=6);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:
#VCPUv7

# ======== ('CODE', 'main', code0)
def code0():
	label('main');
	_PROLOGUE(12,8,0x0); # save=None
	LDWI('ctrlBits_v5');PEEKA(R23);
	_SP(-1+12);POKEA(R23);
	MOVQW(124,R8);
	CALLI('SYS_ExpanderControl');
	MOVIW(0x8200,R8);
	MOVQW(3,R9);
	MOVQW(160,R10);
	CALLI('memset');
	_LDLW(-1+12);LD(vACL);STW(R8);
	CALLI('SYS_ExpanderControl');
	MOVIW('.16',R8);
	CALLI('cprintf');
	LDI(0);
	label('.15');
	_EPILOGUE(12,8,0x0,saveAC=True);
# ======== ('DATA', '.16', code1, 0, 1)
def code1():
	label('.16');
	bytes(10,10,72,101,108,108,111,32);
	bytes(87,111,114,108,100,10,10,0);
# ======== (epilog)
code=[
	('EXPORT', 'main'),
	('CODE', 'main', code0),
	('IMPORT', 'SYS_ExpanderControl'),
	('IMPORT', 'ctrlBits_v5', 'AT', 0x1f8),
	('IMPORT', 'cprintf'),
	('IMPORT', 'memset'),
	('DATA', '.16', code1, 0, 1) ]
module(code=code, name='../gigatron/map128k/libcon1/test.c', cpu=7);

# Local Variables:
# mode: python
# indent-tabs-mode: t
# End:


def scope():
        
    def code_bank():
        # Clobbers R21, R22
        nohop()
        ## save current bank
        label('_cons_save_current_bank')
        LDWI('.savx');STW(R22);
        LDWI('ctrlBits_v5');PEEK();POKE(R22)
        RET()
        ## restore_saved_bank
        label('_cons_restore_saved_bank')
        LDW('sysFn');STW(R21)
        LDWI('SYS_ExpanderControl_v4_40');STW('sysFn');
        label('.savx', pc()+1)
        LDI(0x00bc);SYS(40)
        LDW(R21);STW('sysFn')
        RET()
        ## set video bank
        label('_cons_set_bank')
        LDW('sysFn');STW(R21)
        LDWI('SYS_ExpanderControl_v4_40');STW('sysFn');
        LDWI('ctrlBits_v5');PEEK();ANDI(0x3c);ORI(0x40);SYS(40)
        LDW(R21);STW('sysFn')
        RET()
        
    module(name='cons_bank.s',
           code=[ ('EXPORT', '_cons_save_current_bank'),
                  ('EXPORT', '_cons_restore_saved_bank'),
                  ('EXPORT', '_cons_set_bank'),
                  ('CODE', '_cons_set_bank', code_bank),
                  ('PLACE', '_cons_set_bank', 0x0200, 0x7fff) ] )

    
    # -- int _console_printchars(int fgbg, char *addr, const char *s, int len)
    #
    # Draws up to `len` characters from string `s` at the screen
    # position given by address `addr`.  This assumes that the
    # horizontal offsets in the string table are all zero. All
    # characters are printed on a single line (no newline).  The
    # function returns when any of the following conditions is met:
    # (1) `len` characters have been printed, (2) the next character
    # would not fit horizontally on the screen, or (3), an unprintable
    # character, i.e. not in [0x20-0x83], has been met.

    def code_printchars():
        label('_console_printchars')
        PUSH()
        CALLI('_cons_save_current_bank')
        _MOVIW('SYS_VDrawBits_134','sysFn')      # prep sysFn
        LDW(R8);STW('sysArgs0')                  # move fgbg, freeing R8
        LDI(0);STW(R12)                          # R12: character counter
        label('.loop')
        LDW(R10);PEEK();STW(R8)                  # R8: character code
        if args.cpu >= 6:
            INCV(R10)
        else:
            LDI(1);ADDW(R10);STW(R10)            # next char
        LDW(R9);STW('sysArgs4')                  # destination address
        ADDI(6);STW(R9);                         # next address
        LD(vACL);SUBI(0xA0);_BGT('.ret')         # beyond screen?
        _LDI('font32up');STW(R13)                # R13: font address
        LDW(R8);SUBI(32);_BLT('.ret'  )          # c<32
        STW(R8);SUBI(50);_BLT('.draw')           # 32 <= c < 82
        STW(R8);SUBI(50);_BGE('.ret')            # >= 132
        _LDI('font82up');STW(R13)
        label('.draw')
        CALLI('_printonechar')
        if args.cpu >= 6:
            INCV(R12);LDW(R12)
        else:
            LDI(1);ADDW(R12);STW(R12);           # increment counter
        XORW(R11);_BNE('.loop')                  # loop
        label('.ret')
        tryhop(4);LDW(R12);POP();RET()

    def code_printonechar():
        nohop()
        label('_printonechar')
        PUSH()
        CALLI('_cons_set_bank')
        LDW(R8);LSLW();LSLW();ADDW(R8);ADDW(R13)
        STW(R13);LUP(0);ST('sysArgs2');SYS(134);INC('sysArgs4')
        LDW(R13);LUP(1);ST('sysArgs2');SYS(134);INC('sysArgs4')
        LDW(R13);LUP(2);ST('sysArgs2');SYS(134);INC('sysArgs4')
        LDW(R13);LUP(3);ST('sysArgs2');SYS(134);INC('sysArgs4')
        LDW(R13);LUP(4);ST('sysArgs2');SYS(134);INC('sysArgs4')
        LDI(0);ST('sysArgs2');SYS(134)
        CALLI('_cons_restore_saved_bank')
        tryhop(2);POP();RET()

    module(name='cons_printchar.s',
           code=[ ('EXPORT', '_console_printchars'),
                  ('IMPORT', '_cons_save_current_bank'),
                  ('IMPORT', '_cons_set_bank'),
                  ('IMPORT', '_cons_restore_saved_bank'),
                  ('CODE', '_console_printchars', code_printchars),
                  ('PLACE', '_console_printchars', 0x0200, 0x7fff),
                  ('CODE', '_printonechar', code_printonechar),
                  ('PLACE', '_printonechar', 0x0200, 0x7fff) ] )

    
    # -- void _console_clear(char *addr, char clr, char nl)
    # Clears from addr to the end of line with color clr.
    # Repeats for nl successive lines.

    def code_clear():
        label('_console_clear')
        PUSH()
        CALLI('_cons_save_current_bank')
        if args.cpu >= 7:
            CALLI('_cons_set_bank')
            LD(R9);ANDI(0x3f);STW(T3)
            LDI(160);SUBW(R8);ST(R11)
            LDW(R8);STW(T2)
            LD(R10);ST(R11+1);LDW(R11)
            FILL()
        else:
            CALLI('_cons_set_bank')
            _MOVIW('SYS_SetMemory_v2_54','sysFn')
            LDI(160);SUBW(R8);ST(R11)
            LD(R9);ANDI(0x3f);ST('sysArgs1')
            label('.loop')
            LD(R11);ST('sysArgs0')
            LDWI(0x8000);ORW(R8);STW('sysArgs2')
            SYS(54)
            INC(R8+1)
            if args.cpu >= 6:
                DBNE(R10,'.loop')
            else:
                LDW(R10);SUBI(1);STW(R10)
                _BNE('.loop')
        CALLI('_cons_restore_saved_bank')
        tryhop(2);POP();RET()

    module(name='cons_clear.s',
           code=[ ('EXPORT', '_console_clear'),
                  ('IMPORT', '_cons_save_current_bank'),
                  ('IMPORT', '_cons_set_bank'),
                  ('IMPORT', '_cons_restore_saved_bank'),
                  ('CODE', '_console_clear', code_clear),
                  ('PLACE', '_console_clear', 0x0200, 0x7fff) ] )
    
scope()

# Local Variables:
# mode: python
# indent-tabs-mode: ()
# End:


def scope():

    screenStart=130
    screenEnd=screenStart+120

    def code0():
        nohop()
        label('_con128ksetup')
        LDWI('videoTable');STW(R8)
        LDI(screenStart);STW(R9)
        label('.c128loop')
        LDW(R9);DOKE(R8)
        LDI(2);ADDW(R8);STW(R8)
        LDI(1);ADDW(R9);STW(R9)
        XORI(screenEnd);BNE('.c128loop')
        RET()
        
    def code1():
        nohop()
        label('_map128ksetup')
        # copy gt1 data into bank2
        PUSH()
        LDWI('SYS_LSRW2_52');STW('sysFn')
        LDI(0);STW(R8)
        LDWI('ctrlBits_v5');PEEK();SYS(52);ANDI(0x30);ORI(0x80);ST(R8+1)
        LDWI('SYS_CopyMemoryExt_v6_100');STW('sysFn')
        LDWI('_egt1');DEEK();SUBI(1);ORI(255);XORI(255);STW(R9)
        _BRA('.m128copytest')
        label('.m128copyloop')
        STW('sysArgs0');STW('sysArgs2')
        LDW(R8);SYS(100)
        LDWI(-256);ADDW(R9);STW(R9)
        label('.m128copytest')
        BLT('.m128copyloop')
        POP()
        LDWI('SYS_ExpanderControl_v4_40');STW('sysFn')
        LDWI('ctrlBits_v5');PEEK();ANDI(0x3c);ORI(0x80);SYS(40)
        PUSH()
        CALLI('_con128ksetup')
        LDWI(screenStart << 8);STW(R8)
        LDI(0);STW(R9)
        LDI(120);STW(R10)
        CALLI('_console_clear')
        tryhop(2);POP();RET()
    
    module(name='map128ksetup.s',
           code=[ ('EXPORT', '_map128ksetup'),
                  ('EXPORT', '_con128ksetup'),
                  ('IMPORT', '_egt1'),
                  ('IMPORT', '_console_clear'),
                  ('CODE', '_con128ksetup', code0),
                  ('CODE', '_map128ksetup', code1),
                  ('PLACE', '_map128ksetup', 0x0200, 0x7fff) ] )
    
scope()

# Local Variables:
# mode: python
# indent-tabs-mode: ()
# End:
